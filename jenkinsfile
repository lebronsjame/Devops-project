pipeline {
    agent any

    environment {
        // This tells Playwright it's running in CI mode
        CI = 'true'
    }

    stages {
        stage('Cleanup') {
            steps {
                // Kill any hanging node processes from previous failed runs
                // '|| exit 0' ensures the pipeline doesn't fail if no node process is found
                bat 'taskkill /F /IM node.exe /T || exit 0'
            }
        }

        stage('Install') {
            steps {
                bat 'npm ci'
                // Ensure Playwright browsers are installed (essential for Jenkins agents)
                bat 'npx playwright install --with-deps'
            }
        }

        stage('Test - Jest') {
            steps {
                bat 'npx jest --coverage'
            }
        }

        stage('Test - Playwright') {
            steps {
                // We use --project=chromium if you want to speed it up, 
                // or keep it as is to run all browsers.
                bat 'npx playwright test'
            }
        }

        stage('Build Docker Image') {
            steps {
                bat 'docker build -t skilllink-app .'
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                bat 'kubectl apply -f deployment.yaml'
                bat 'kubectl apply -f service.yaml'
                bat 'kubectl rollout status deployment/skilllink-deployment'
            }
        }
    } 

    post {
        always {
            // Archive Playwright reports and traces so you can see WHY it failed
            publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'playwright-report', reportFiles: 'index.html', reportName: 'Playwright Report', reportTitles: ''])
        }
        success {
            mail to: 'pugproof2@gmail.com',
                 subject: "SkillLink Pipeline SUCCESS - Build #${env.BUILD_NUMBER}",
                 body: "The CI/CD pipeline completed successfully.\n\nBuild URL: ${env.BUILD_URL}"
        }
        failure {
            mail to: 'pugproof2@gmail.com',
                 subject: "SkillLink Pipeline FAILED - Build #${env.BUILD_NUMBER}",
                 body: "The pipeline failed.\n\nCheck details here:\n${env.BUILD_URL}"
        }
    }
}